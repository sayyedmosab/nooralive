# Frontend Stabilization Plan: React Migration Fix

## 1. Analysis of Legacy Features (Target State)

The original vanilla JavaScript frontend (`stash/chatreplit_legacy/frontendold/`) defined the following critical features and behaviors that must be fully functional in the current React implementation:

| Feature                    | Description                                                                 | Implementation Details (Legacy)                                                                         |
| :------------------------- | :-------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------ |
| **Chat Interface**         | Send user questions and display agent responses.                            | Handled by `sendQuestion()` and `addMessage()` in `index.html`.                                         |
| **Markdown Rendering**     | Agent responses must support full Markdown formatting.                      | Uses `marked.js` and `DOMPurify.js` for rendering and sanitization.                                     |
| **Conversation History**   | Load and display past conversations from the backend.                       | Uses `/api/v1/chat/conversations` and `loadConversationHistory()`.                                      |
| **Debug Panel**            | Toggleable sidebar to display raw LLM communication logs.                   | Uses `toggleDebugPanel()` and `loadDebugLogs()` to filter for `raw_llm_request` and `raw_llm_response`. |
| **Clarification Handling** | Display special UI for clarification requests from the agent.               | Checks for `clarification_needed` in API response and renders a dedicated HTML block.                   |
| **Artifact Creation**      | Display data artifacts (Tables, Charts) generated by the agent.             | Uses `canvasManager.createArtifact()` for `TABLE` and `CHART` types.                                    |
| **Canvas Management**      | 3-mode layout control for artifacts: `collapsed`, `expanded`, `fullscreen`. | Handled by the `CanvasManager` class in `canvas-manager.js`.                                            |
| **Confidence Score**       | Display the confidence level of the agent's response.                       | Renders a badge based on `data.confidence` score/level.                                                 |
| **Error Handling**         | Display user-friendly error messages for API failures.                      | Includes detailed client-side error parsing and display logic.                                          |

## 2. Gaps and Required Fixes (Checklist)

The current React implementation must be validated against these features. The primary task is to stabilize the messy migration by implementing these features idiomatically in React/TypeScript.

### Core Chat & API Handshake

- [ ] **API Client:** Validate the React application's API client (likely using `fetch` or a library) correctly targets `http://localhost:8008/api/v1/chat/message` (or the Ngrok URL if configured).
- [ ] **Request/Response Schema:** Ensure the React components correctly construct the request body (including `query`, `persona`, and `conversation_id`) and parse the full response schema (including `message`, `data`, `artifacts`, `insights`, `confidence`, and `metadata`).
- [ ] **History Retrieval:** Implement the logic to call `/api/v1/chat/conversations` and render the conversation list and load individual conversation history.

### UI/UX Feature Parity

- [ ] **Markdown/Sanitization:** Implement Markdown rendering and HTML sanitization within the message display components.
- [ ] **Debug Panel:** Implement the logic to fetch and display filtered debug logs (specifically `raw_llm_request` and `raw_llm_response`) from the backend's debug endpoint (`/api/v1/debug/logs/{conversation_id}`).
- [ ] **Clarification UI:** Implement the dedicated React component/logic to render the clarification request UI based on the API response.
- [ ] **Confidence Display:** Implement the component to display the confidence score/badge.

### Canvas/Artifact Integration

- [ ] **Canvas Logic Refactor:** Refactor the vanilla JS `CanvasManager` logic into a React context or hook to manage the 3-mode state (`hidden`, `collapsed`, `expanded`, `fullscreen`).
- [ ] **Artifact Rendering:** Implement React components to render `TABLE` artifacts (using the provided data structure) and `CHART` artifacts (assuming a charting library like Highcharts is used, as suggested by the legacy code).

## 3. Next Steps (New Orchestrator Plan)

The next phase will focus on implementing the necessary fixes in the React codebase.

1.  **Task C05 (Frontend Fix - API & State):** Implement the core chat logic, API client, and state management to handle message sending, conversation ID tracking, and basic response parsing.
2.  **Task C06 (Frontend Fix - Debug & History):** Implement the conversation history sidebar and the debug panel functionality, ensuring API calls to `/api/v1/chat/conversations` and `/api/v1/debug/logs/{conversation_id}` are correctly handled.
3.  **Task C07 (Frontend Fix - Canvas & UI):** Refactor the canvas management logic and implement artifact rendering components (Table, Chart) to achieve feature parity with the legacy system.
